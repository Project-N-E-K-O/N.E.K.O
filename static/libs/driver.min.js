/**
 * 简化版 Driver.js 实现
 * 用于 N.E.K.O 新手引导系统
 * 不依赖外部 CDN，完全本地实现
 */

(function(global) {
    'use strict';

    class Driver {
        constructor(options = {}) {
            this.options = {
                padding: options.padding || 8,
                allowClose: options.allowClose !== false,
                overlayClickNext: options.overlayClickNext || false,
                animate: options.animate !== false,
                className: options.className || 'driver-default',
                ...options
            };

            this.steps = [];
            this.currentStep = 0;
            this.isActive = false;
            this.overlay = null;
            this.popover = null;
            this.highlight = null;
            this.listeners = {};

            this.init();
        }

        init() {
            // 创建样式
            this.createStyles();
        }

        createStyles() {
            if (document.getElementById('driver-inline-styles')) return;

            const style = document.createElement('style');
            style.id = 'driver-inline-styles';
            style.textContent = `
                .driver-overlay {
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    right: 0 !important;
                    bottom: 0 !important;
                    background: rgba(0, 0, 0, 0.15) !important;
                    z-index: 99998 !important;
                }
                .driver-highlight {
                    position: fixed !important;
                    border: 3px solid #44b7fe !important;
                    border-radius: 8px !important;
                    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.15), 0 0 30px rgba(68, 183, 254, 0.8), inset 0 0 30px rgba(255, 255, 255, 0.15) !important;
                    z-index: 99999 !important;
                    pointer-events: none !important;
                    background: rgba(255, 255, 255, 0.05) !important;
                }
                .driver-popover {
                    position: fixed !important;
                    background: rgba(30, 30, 40, 0.95) !important;
                    border: 1px solid rgba(68, 183, 254, 0.3) !important;
                    border-radius: 12px !important;
                    padding: 20px !important;
                    max-width: 380px !important;
                    z-index: 100000 !important;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4) !important;
                    backdrop-filter: blur(10px) !important;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
                }
                .driver-popover-title {
                    color: #44b7fe !important;
                    font-size: 16px !important;
                    font-weight: 600 !important;
                    margin-bottom: 12px !important;
                    letter-spacing: 0.5px !important;
                }
                .driver-popover-description {
                    color: rgba(255, 255, 255, 0.85) !important;
                    font-size: 14px !important;
                    line-height: 1.6 !important;
                    margin-bottom: 16px !important;
                }
                .driver-popover-footer {
                    display: flex !important;
                    gap: 10px !important;
                    justify-content: flex-end !important;
                    margin-top: 16px !important;
                }
                .driver-popover-footer button {
                    padding: 8px 16px !important;
                    border-radius: 6px !important;
                    font-size: 13px !important;
                    font-weight: 500 !important;
                    cursor: pointer !important;
                    border: none !important;
                    outline: none !important;
                    transition: all 0.2s ease !important;
                    pointer-events: auto !important;
                    z-index: 100001 !important;
                }
                .driver-popover-footer button:first-child {
                    background: rgba(68, 183, 254, 0.15) !important;
                    color: #44b7fe !important;
                    border: 1px solid rgba(68, 183, 254, 0.3) !important;
                }
                .driver-popover-footer button:first-child:hover {
                    background: rgba(68, 183, 254, 0.25) !important;
                    border-color: rgba(68, 183, 254, 0.5) !important;
                }
                .driver-popover-footer button:last-child {
                    background: linear-gradient(135deg, #44b7fe 0%, #40C5F1 100%) !important;
                    color: #fff !important;
                }
                .driver-popover-footer button:last-child:hover {
                    background: linear-gradient(135deg, #3aa8f0 0%, #38b8e3 100%) !important;
                    box-shadow: 0 4px 12px rgba(68, 183, 254, 0.4) !important;
                }
            `;
            document.head.appendChild(style);
        }

        setSteps(steps) {
            this.steps = steps;
        }

        start() {
            if (this.steps.length === 0) {
                console.warn('[Driver] No steps defined');
                return;
            }

            this.isActive = true;
            this.currentStep = 0;
            this.showStep(0);
        }

        showStep(index) {
            if (index < 0 || index >= this.steps.length) {
                this.destroy();
                return;
            }

            this.currentStep = index;
            const step = this.steps[index];

            // 移除旧的高亮和弹窗
            this.removeHighlight();
            this.removePopover();

            // 获取目标元素
            const element = document.querySelector(step.element);
            if (!element) {
                console.warn(`[Driver] Element not found: ${step.element}`);
                return;
            }

            // 创建高亮
            this.createHighlight(element);

            // 创建弹窗
            this.createPopover(element, step.popover, index);

            // 触发事件
            this.emit('next');
        }

        createHighlight(element) {
            const rect = element.getBoundingClientRect();
            const padding = this.options.padding;

            // 创建遮罩层
            this.overlay = document.createElement('div');
            this.overlay.className = 'driver-overlay';
            document.body.appendChild(this.overlay);

            // 创建高亮框
            this.highlight = document.createElement('div');
            this.highlight.className = 'driver-highlight';
            this.highlight.style.top = (rect.top - padding) + 'px';
            this.highlight.style.left = (rect.left - padding) + 'px';
            this.highlight.style.width = (rect.width + padding * 2) + 'px';
            this.highlight.style.height = (rect.height + padding * 2) + 'px';
            document.body.appendChild(this.highlight);

            console.log('[Driver] Highlight created at:', {
                top: rect.top - padding,
                left: rect.left - padding,
                width: rect.width + padding * 2,
                height: rect.height + padding * 2
            });
        }

        createPopover(element, content, stepIndex) {
            const rect = element.getBoundingClientRect();

            this.popover = document.createElement('div');
            this.popover.className = 'driver-popover';

            let html = '';
            if (content.title) {
                html += `<div class="driver-popover-title">${content.title}</div>`;
            }
            if (content.description) {
                html += `<div class="driver-popover-description">${content.description}</div>`;
            }

            html += '<div class="driver-popover-footer">';
            if (stepIndex > 0) {
                html += '<button class="driver-prev">上一步</button>';
            }
            if (stepIndex < this.steps.length - 1) {
                html += '<button class="driver-next">下一步</button>';
            } else {
                html += '<button class="driver-finish">完成</button>';
            }
            html += '</div>';

            this.popover.innerHTML = html;
            document.body.appendChild(this.popover);

            console.log('[Driver] Popover created');

            // 绑定按钮事件
            const prevBtn = this.popover.querySelector('.driver-prev');
            const nextBtn = this.popover.querySelector('.driver-next');
            const finishBtn = this.popover.querySelector('.driver-finish');

            if (prevBtn) {
                prevBtn.addEventListener('click', () => this.showStep(stepIndex - 1));
            }
            if (nextBtn) {
                nextBtn.addEventListener('click', () => this.showStep(stepIndex + 1));
            }
            if (finishBtn) {
                finishBtn.addEventListener('click', () => this.destroy());
            }

            // 定位弹窗
            setTimeout(() => this.positionPopover(rect), 0);
        }

        positionPopover(elementRect) {
            if (!this.popover) return;

            // 简单定位：居中显示
            const popoverWidth = 380;
            const popoverHeight = this.popover.offsetHeight;

            let top = (window.innerHeight - popoverHeight) / 2;
            let left = (window.innerWidth - popoverWidth) / 2;

            // 确保不超出视口
            if (top < 20) top = 20;
            if (left < 20) left = 20;
            if (top + popoverHeight > window.innerHeight - 20) {
                top = window.innerHeight - popoverHeight - 20;
            }

            this.popover.style.top = top + 'px';
            this.popover.style.left = left + 'px';

            console.log('[Driver] Popover positioned at:', { top, left, width: popoverWidth, height: popoverHeight });
        }

        removeHighlight() {
            if (this.overlay) {
                this.overlay.remove();
                this.overlay = null;
            }
            if (this.highlight) {
                this.highlight.remove();
                this.highlight = null;
            }
        }

        removePopover() {
            if (this.popover) {
                this.popover.remove();
                this.popover = null;
            }
        }

        destroy() {
            console.log('[Driver] Destroying driver');
            this.removeHighlight();
            this.removePopover();
            this.isActive = false;
            this.emit('destroy');
        }

        on(event, callback) {
            if (!this.listeners[event]) {
                this.listeners[event] = [];
            }
            this.listeners[event].push(callback);
        }

        emit(event) {
            if (this.listeners[event]) {
                this.listeners[event].forEach(callback => callback());
            }
        }
    }

    // 暴露到全局
    global.driver = Driver;
    global.Driver = Driver;

    console.log('[Driver] Driver.js loaded successfully');

})(window);
