name: Build Desktop App (Cross-Platform)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. 1.0.0-beta.1)'
        required: false
        default: ''
      electron_repo:
        description: 'Electron frontend repo (owner/repo)'
        required: false
        default: 'Project-N-E-K-O/N.E.K.O.-PC'
      electron_ref:
        description: 'Electron repo branch/tag/commit'
        required: false
        default: 'main'
      skip_signing:
        description: 'Skip code signing'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # ──────────────────────────────────────────────
  # Step 0: Calculate version
  # ──────────────────────────────────────────────
  version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.calc.outputs.VERSION }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate version
        id: calc
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            COMMIT_SHORT=$(git rev-parse --short HEAD)
            DATE=$(date +%Y%m%d)
            VERSION="${DATE}-${COMMIT_SHORT}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Resolved version: $VERSION"

  # ──────────────────────────────────────────────
  # Step 1: Build Python backend with Nuitka
  # ──────────────────────────────────────────────
  build-python:
    needs: version
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: win
            artifact_name: python-backend-win
            output_binary: projectneko_server.exe
          - os: macos-13
            platform: mac-x64
            artifact_name: python-backend-mac-x64
            output_binary: projectneko_server
          - os: macos-latest
            platform: mac-arm64
            artifact_name: python-backend-mac-arm64
            output_binary: projectneko_server
          - os: ubuntu-latest
            platform: linux
            artifact_name: python-backend-linux
            output_binary: projectneko_server

    runs-on: ${{ matrix.os }}
    timeout-minutes: 120
    steps:
      - name: Checkout backend repo
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Create venv and install dependencies
        shell: bash
        run: |
          uv venv .venv
          uv sync
          uv pip install --python .venv nuitka ordered-set zstandard

      # --- Platform-specific system dependencies ---
      - name: Install Linux system dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            pkg-config \
            portaudio19-dev \
            patchelf \
            ccache

      - name: Install macOS build tools
        if: runner.os == 'macOS'
        run: |
          brew install ccache || true

      # --- Pre-install Playwright Chromium for bundle ---
      - name: Install Playwright Chromium (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p playwright_browsers
          PLAYWRIGHT_BROWSERS_PATH="$(pwd)/playwright_browsers" \
            .venv/bin/python -m playwright install chromium || \
            echo "[WARNING] Playwright Chromium install failed; will download on first run."

      - name: Install Playwright Chromium (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (-not (Test-Path "playwright_browsers")) { New-Item -ItemType Directory -Path "playwright_browsers" }
          $env:PLAYWRIGHT_BROWSERS_PATH = "${{ github.workspace }}\playwright_browsers"
          .venv\Scripts\python.exe -m playwright install chromium
          if ($LASTEXITCODE -ne 0) {
            Write-Warning "Playwright Chromium install failed; will download on first run."
          }

      # --- Build with Nuitka ---
      - name: Build with Nuitka (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          NUITKA_OPTS="--standalone"
          NUITKA_OPTS="$NUITKA_OPTS --output-dir=dist"
          NUITKA_OPTS="$NUITKA_OPTS --output-filename=projectneko_server"

          # Version metadata
          NUITKA_OPTS="$NUITKA_OPTS --company-name=Project_N.E.K.O."
          NUITKA_OPTS="$NUITKA_OPTS --product-name=N.E.K.O._AI_Assistant"
          NUITKA_OPTS="$NUITKA_OPTS --file-version=${{ needs.version.outputs.version || '1.0.0.0' }}"
          NUITKA_OPTS="$NUITKA_OPTS --product-version=${{ needs.version.outputs.version || '1.0.0.0' }}"

          # Config data files
          NUITKA_OPTS="$NUITKA_OPTS --include-data-files=config/__init__.py=config/__init__.py"
          NUITKA_OPTS="$NUITKA_OPTS --include-data-files=config/api_providers.json=config/api_providers.json"
          NUITKA_OPTS="$NUITKA_OPTS --include-data-files=config/characters.json=config/characters.json"
          NUITKA_OPTS="$NUITKA_OPTS --include-data-files=config/characters.en.json=config/characters.en.json"
          NUITKA_OPTS="$NUITKA_OPTS --include-data-files=config/characters.ja.json=config/characters.ja.json"
          NUITKA_OPTS="$NUITKA_OPTS --include-data-files=config/characters.ko.json=config/characters.ko.json"
          NUITKA_OPTS="$NUITKA_OPTS --include-data-files=config/characters.zh-CN.json=config/characters.zh-CN.json"
          NUITKA_OPTS="$NUITKA_OPTS --include-data-files=config/characters.zh-TW.json=config/characters.zh-TW.json"
          NUITKA_OPTS="$NUITKA_OPTS --include-data-files=config/core_config.json=config/core_config.json"
          NUITKA_OPTS="$NUITKA_OPTS --include-data-files=config/prompts_chara.py=config/prompts_chara.py"
          NUITKA_OPTS="$NUITKA_OPTS --include-data-files=config/prompts_sys.py=config/prompts_sys.py"
          NUITKA_OPTS="$NUITKA_OPTS --include-data-files=config/user_preferences.json=config/user_preferences.json"

          # Data directories
          NUITKA_OPTS="$NUITKA_OPTS --include-data-dir=assets=assets"
          NUITKA_OPTS="$NUITKA_OPTS --include-data-dir=templates=templates"
          NUITKA_OPTS="$NUITKA_OPTS --include-data-dir=data/browser_use_prompts=data/browser_use_prompts"
          NUITKA_OPTS="$NUITKA_OPTS --include-data-dir=playwright_browsers=playwright_browsers"
          NUITKA_OPTS="$NUITKA_OPTS --include-data-dir=static=static"

          # Packages
          NUITKA_OPTS="$NUITKA_OPTS --include-package=uvicorn"
          NUITKA_OPTS="$NUITKA_OPTS --include-package=fastapi"
          NUITKA_OPTS="$NUITKA_OPTS --include-package=starlette"
          NUITKA_OPTS="$NUITKA_OPTS --include-package=jinja2"
          NUITKA_OPTS="$NUITKA_OPTS --include-package=websockets"
          NUITKA_OPTS="$NUITKA_OPTS --include-package=langchain_community"
          NUITKA_OPTS="$NUITKA_OPTS --include-package=langchain_core"
          NUITKA_OPTS="$NUITKA_OPTS --include-package=langchain_openai"
          NUITKA_OPTS="$NUITKA_OPTS --include-package=main_server"
          NUITKA_OPTS="$NUITKA_OPTS --include-package=memory_server"
          NUITKA_OPTS="$NUITKA_OPTS --include-package=agent_server"
          NUITKA_OPTS="$NUITKA_OPTS --include-package=config"
          NUITKA_OPTS="$NUITKA_OPTS --include-package=brain"
          NUITKA_OPTS="$NUITKA_OPTS --include-package=main_logic"
          NUITKA_OPTS="$NUITKA_OPTS --include-package=main_routers"
          NUITKA_OPTS="$NUITKA_OPTS --include-package=memory"
          NUITKA_OPTS="$NUITKA_OPTS --include-package=utils"
          NUITKA_OPTS="$NUITKA_OPTS --include-package=steamworks"
          NUITKA_OPTS="$NUITKA_OPTS --include-package=browser_use"
          NUITKA_OPTS="$NUITKA_OPTS --include-package=browser_use_sdk"
          NUITKA_OPTS="$NUITKA_OPTS --include-package=playwright"

          # Package data
          NUITKA_OPTS="$NUITKA_OPTS --include-package-data=audiolab"
          NUITKA_OPTS="$NUITKA_OPTS --include-package-data=pyrnnoise"
          NUITKA_OPTS="$NUITKA_OPTS --include-package-data=browser_use"
          NUITKA_OPTS="$NUITKA_OPTS --include-package-data=playwright"
          NUITKA_OPTS="$NUITKA_OPTS --include-package-data=jinja2"
          NUITKA_OPTS="$NUITKA_OPTS --include-package-data=certifi"
          NUITKA_OPTS="$NUITKA_OPTS --include-package-data=bilibili_api"

          # Exclusions
          NUITKA_OPTS="$NUITKA_OPTS --nofollow-import-to=plugin.plugins"
          NUITKA_OPTS="$NUITKA_OPTS --nofollow-import-to=audiolab"
          NUITKA_OPTS="$NUITKA_OPTS --nofollow-import-to=pyrnnoise"
          NUITKA_OPTS="$NUITKA_OPTS --nofollow-import-to=matplotlib"
          NUITKA_OPTS="$NUITKA_OPTS --nofollow-import-to=pytest"

          # Plugin
          NUITKA_OPTS="$NUITKA_OPTS --enable-plugin=dill-compat"

          # Steam files (include if present in repo)
          NUITKA_OPTS="$NUITKA_OPTS --include-data-files=steam_appid.txt=steam_appid.txt"
          if [ -f "libsteam_api.dylib" ]; then
            NUITKA_OPTS="$NUITKA_OPTS --include-data-files=libsteam_api.dylib=libsteam_api.dylib"
          fi
          if [ -f "SteamworksPy.dylib" ]; then
            NUITKA_OPTS="$NUITKA_OPTS --include-data-files=SteamworksPy.dylib=SteamworksPy.dylib"
          fi
          if [ -f "libsteam_api.so" ]; then
            NUITKA_OPTS="$NUITKA_OPTS --include-data-files=libsteam_api.so=libsteam_api.so"
          fi
          if [ -f "SteamworksPy.so" ]; then
            NUITKA_OPTS="$NUITKA_OPTS --include-data-files=SteamworksPy.so=SteamworksPy.so"
          fi

          echo "=== Nuitka options ==="
          echo "$NUITKA_OPTS" | tr ' ' '\n'
          echo "======================"

          .venv/bin/python -m nuitka $NUITKA_OPTS launcher.py

      - name: Build with Nuitka (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          set NUITKA_OPTS=--standalone --output-dir="dist" --output-filename="projectneko_server.exe"
          set NUITKA_OPTS=%NUITKA_OPTS% --windows-icon-from-ico=assets/icon.ico
          set NUITKA_OPTS=%NUITKA_OPTS% --company-name="Project N.E.K.O."
          set NUITKA_OPTS=%NUITKA_OPTS% --product-name="N.E.K.O. AI Assistant"
          set NUITKA_OPTS=%NUITKA_OPTS% --file-version=${{ needs.version.outputs.version || '1.0.0.0' }}
          set NUITKA_OPTS=%NUITKA_OPTS% --product-version=${{ needs.version.outputs.version || '1.0.0.0' }}
          set NUITKA_OPTS=%NUITKA_OPTS% --include-data-files=config/__init__.py=config/__init__.py
          set NUITKA_OPTS=%NUITKA_OPTS% --include-data-files=config/api_providers.json=config/api_providers.json
          set NUITKA_OPTS=%NUITKA_OPTS% --include-data-files=config/characters.json=config/characters.json
          set NUITKA_OPTS=%NUITKA_OPTS% --include-data-files=config/characters.en.json=config/characters.en.json
          set NUITKA_OPTS=%NUITKA_OPTS% --include-data-files=config/characters.ja.json=config/characters.ja.json
          set NUITKA_OPTS=%NUITKA_OPTS% --include-data-files=config/characters.ko.json=config/characters.ko.json
          set NUITKA_OPTS=%NUITKA_OPTS% --include-data-files=config/characters.zh-CN.json=config/characters.zh-CN.json
          set NUITKA_OPTS=%NUITKA_OPTS% --include-data-files=config/characters.zh-TW.json=config/characters.zh-TW.json
          set NUITKA_OPTS=%NUITKA_OPTS% --include-data-files=config/core_config.json=config/core_config.json
          set NUITKA_OPTS=%NUITKA_OPTS% --include-data-files=config/prompts_chara.py=config/prompts_chara.py
          set NUITKA_OPTS=%NUITKA_OPTS% --include-data-files=config/prompts_sys.py=config/prompts_sys.py
          set NUITKA_OPTS=%NUITKA_OPTS% --include-data-files=config/user_preferences.json=config/user_preferences.json
          set NUITKA_OPTS=%NUITKA_OPTS% --include-data-dir=assets=assets
          set NUITKA_OPTS=%NUITKA_OPTS% --include-data-dir=templates=templates
          set NUITKA_OPTS=%NUITKA_OPTS% --include-data-dir=data/browser_use_prompts=data/browser_use_prompts
          set NUITKA_OPTS=%NUITKA_OPTS% --include-data-dir=playwright_browsers=playwright_browsers
          set NUITKA_OPTS=%NUITKA_OPTS% --include-data-dir=static=static
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package=uvicorn
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package=fastapi
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package=starlette
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package=jinja2
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package=websockets
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package=langchain_community
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package=langchain_core
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package=langchain_openai
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package=main_server
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package=memory_server
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package=agent_server
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package=config
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package=brain
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package=main_logic
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package=main_routers
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package=memory
          set NUITKA_OPTS=%NUITKA_OPTS% --nofollow-import-to=plugin.plugins
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package=utils
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package=steamworks
          set NUITKA_OPTS=%NUITKA_OPTS% --include-data-files=steam_api64.dll=steam_api64.dll
          set NUITKA_OPTS=%NUITKA_OPTS% --include-data-files=steam_api64.lib=steam_api64.lib
          set NUITKA_OPTS=%NUITKA_OPTS% --include-data-files=SteamworksPy64.dll=SteamworksPy64.dll
          set NUITKA_OPTS=%NUITKA_OPTS% --include-data-files=steam_appid.txt=steam_appid.txt
          set NUITKA_OPTS=%NUITKA_OPTS% --nofollow-import-to=audiolab
          set NUITKA_OPTS=%NUITKA_OPTS% --nofollow-import-to=pyrnnoise
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package-data=audiolab
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package-data=pyrnnoise
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package=browser_use
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package-data=browser_use
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package=browser_use_sdk
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package=playwright
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package-data=playwright
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package-data=jinja2
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package-data=certifi
          set NUITKA_OPTS=%NUITKA_OPTS% --include-package-data=bilibili_api
          set NUITKA_OPTS=%NUITKA_OPTS% --enable-plugin=dill-compat
          set NUITKA_OPTS=%NUITKA_OPTS% --nofollow-import-to=matplotlib
          set NUITKA_OPTS=%NUITKA_OPTS% --nofollow-import-to=pytest
          set NUITKA_OPTS=%NUITKA_OPTS% --windows-console-mode=force

          .venv\Scripts\python.exe -m nuitka %NUITKA_OPTS% launcher.py

      # --- Rename Nuitka output directory ---
      - name: Rename build output
        shell: bash
        run: |
          if [ -d "dist/launcher.dist" ]; then
            mv dist/launcher.dist dist/Xiao8
          fi
          echo "=== Build output ==="
          ls -la dist/Xiao8/ || echo "dist/Xiao8 not found!"

      - name: Upload Python backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/Xiao8/
          retention-days: 7
          compression-level: 6

  # ──────────────────────────────────────────────
  # Step 2: Build Electron desktop app
  # ──────────────────────────────────────────────
  build-electron:
    needs: [version, build-python]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: win
            python_artifact: python-backend-win
            electron_args: '--win'
            artifact_name: desktop-win-x64
          - os: macos-13
            platform: mac-x64
            python_artifact: python-backend-mac-x64
            electron_args: '--mac --x64'
            artifact_name: desktop-mac-x64
          - os: macos-latest
            platform: mac-arm64
            python_artifact: python-backend-mac-arm64
            electron_args: '--mac --arm64'
            artifact_name: desktop-mac-arm64
          - os: ubuntu-latest
            platform: linux
            python_artifact: python-backend-linux
            electron_args: '--linux'
            artifact_name: desktop-linux-x64

    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout Electron frontend
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.electron_repo || 'Project-N-E-K-O/N.E.K.O.-PC' }}
          ref: ${{ github.event.inputs.electron_ref || 'main' }}
          token: ${{ secrets.ELECTRON_REPO_TOKEN || secrets.GITHUB_TOKEN }}
          path: electron-app

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: electron-app/package-lock.json

      - name: Download Python backend artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.python_artifact }}
          path: electron-app/bin

      - name: Make server binary executable (Unix)
        if: runner.os != 'Windows'
        run: chmod +x electron-app/bin/projectneko_server

      - name: Install npm dependencies
        working-directory: electron-app
        run: npm ci || npm install

      - name: Update version in package.json
        working-directory: electron-app
        run: |
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '${{ needs.version.outputs.version }}'.replace(/^[^0-9]*/, '');
            if (!/^\d+\.\d+\.\d+/.test(pkg.version)) {
              pkg.version = '0.0.0-' + pkg.version;
            }
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
            console.log('Updated version to:', pkg.version);
          "

      # --- Platform-specific electron-builder config patches ---
      - name: Configure Linux build targets
        if: matrix.platform == 'linux'
        working-directory: electron-app
        run: |
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.build = pkg.build || {};
            pkg.build.linux = {
              target: [
                { target: 'AppImage', arch: ['x64'] },
                { target: 'deb', arch: ['x64'] },
                { target: 'tar.gz', arch: ['x64'] }
              ],
              category: 'Utility',
              icon: 'build/icons'
            };
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
            console.log('Linux build targets configured');
          "

      - name: Install Linux build dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            dpkg \
            fakeroot \
            rpm \
            libarchive-tools

      # --- Build Electron app ---
      - name: Build Electron app
        working-directory: electron-app
        run: npx electron-builder ${{ matrix.electron_args }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: ${{ github.event.inputs.skip_signing != 'false' && 'false' || 'true' }}
          WIN_CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
          WIN_CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}
          CSC_LINK: ${{ secrets.MAC_CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.MAC_CSC_KEY_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: List build output
        working-directory: electron-app/dist
        shell: bash
        run: |
          echo "=== Build artifacts ==="
          ls -lahR . || true

      - name: Upload desktop artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            electron-app/dist/*.exe
            electron-app/dist/*.dmg
            electron-app/dist/*.zip
            electron-app/dist/*.AppImage
            electron-app/dist/*.deb
            electron-app/dist/*.tar.gz
            electron-app/dist/*.rpm
            electron-app/dist/*.blockmap
            electron-app/dist/latest*.yml
          if-no-files-found: warn
          retention-days: 14

  # ──────────────────────────────────────────────
  # Step 3: Create GitHub Release (only on tag push)
  # ──────────────────────────────────────────────
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [version, build-electron]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all desktop artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: desktop-*

      - name: Organize release files
        run: |
          mkdir -p release
          find artifacts -type f \( \
            -name "*.exe" -o -name "*.dmg" -o -name "*.zip" \
            -o -name "*.AppImage" -o -name "*.deb" -o -name "*.tar.gz" \
            -o -name "*.rpm" -o -name "latest*.yml" \
          \) -exec cp {} release/ \;
          echo "=== Release files ==="
          ls -lah release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "N.E.K.O. v${{ needs.version.outputs.version }}"
          body: |
            ## N.E.K.O. v${{ needs.version.outputs.version }}

            ### Downloads
            | Platform | Architecture | File |
            |----------|-------------|------|
            | Windows | x64 | `N.E.K.O.exe` (Portable) |
            | macOS | Intel (x64) | `N.E.K.O-*.dmg` or `.zip` |
            | macOS | Apple Silicon (arm64) | `N.E.K.O-*-arm64.dmg` or `.zip` |
            | Linux | x64 | `N.E.K.O-*.AppImage` / `.deb` / `.tar.gz` |

            ### Notes
            - First launch may take a moment as the Python backend initializes
            - Default server port: `48911`

            ---
            Built by GitHub Actions
          files: release/*
          draft: true
          prerelease: ${{ contains(needs.version.outputs.version, 'beta') || contains(needs.version.outputs.version, 'alpha') || contains(needs.version.outputs.version, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
