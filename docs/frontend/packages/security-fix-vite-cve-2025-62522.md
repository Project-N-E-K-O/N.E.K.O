# Vite 依赖漏洞修复 - 溯源分析与解决方案

**日期**：2026-01-10  
**类型**：Security Fix / 依赖升级  
**CVE 编号**：CVE-2025-62522  
**影响范围**：N.E.K.O 和 N.E.K.O.-RN 项目的所有使用 vite 的 packages  
**优先级**：高（安全漏洞）

---

## 执行摘要

### 问题
两个项目中的多个 packages 使用了存在安全漏洞的 vite 版本 `^7.1.7`（受 CVE-2025-62522 影响）。

### 根本原因
1. **上游问题**：N.E.K.O 项目在添加 vite 依赖时使用了 `^7.1.7`，该版本后来被发现存在安全漏洞
2. **同步传播**：通过 `sync-neko-packages.js` 脚本，该依赖被同步到 N.E.K.O.-RN 项目
3. **缺少防护**：N.E.K.O.-RN 没有 override 机制来防止上游的不安全依赖被同步

### 解决方案
1. **上游修复**：在 N.E.K.O 项目中将 vite 升级到 `^7.1.11`（已修复漏洞）
2. **下游防护**：在 N.E.K.O.-RN 的 `packages-overrides/` 中添加 package.json 覆盖文件
3. **文档更新**：记录问题和解决方案，防止未来重复

---

## 漏洞详情

### CVE-2025-62522

**描述**：Vite 开发服务器在 Windows 上运行时，允许访问被 `server.fs.deny` 拒绝的文件，如果 URL 以反斜杠 (`\`) 结尾。

**影响版本**：
- 2.9.18 到 3.0.0（不包含）
- 3.2.9 到 4.0.0
- 4.5.3 到 5.0.0
- 5.2.6 到 5.4.21
- 6.0.0 到 6.4.1
- 7.0.0 到 7.0.8
- **7.1.0 到 7.1.11**（我们使用的 ^7.1.7 在此范围内）

**修复版本**：
- 5.x: ≥ 5.4.21
- 6.x: ≥ 6.4.1
- 7.0.x: ≥ 7.0.8
- **7.1.x: ≥ 7.1.11**（我们需要升级到此版本）

**严重程度**：中等（主要影响开发环境）

**参考**：
- [NVD - CVE-2025-62522](https://nvd.nist.gov/vuln/detail/CVE-2025-62522)
- [Vulert - CVE-2025-62522](https://vulert.com/vuln-db/CVE-2025-62522)

---

## 问题溯源

### 时间线

1. **2026-01-10（早期）**：
   - N.E.K.O 项目在 `bugfix-metro-vite-dependency-2026-01-10.md` 中记录：为 packages 添加显式 vite 依赖
   - 使用版本：`^7.1.7`（当时可能是最新稳定版）
   - 影响文件：
     - `frontend/packages/common/package.json`
     - `frontend/packages/components/package.json`
     - `frontend/packages/audio-service/package.json`
     - `frontend/packages/live2d-service/package.json`
     - `frontend/packages/realtime/package.json`

2. **2026-01-10（同日或稍后）**：
   - CVE-2025-62522 被公开
   - Vite 发布 7.1.11 修复版本

3. **2026-01-10（本次修复）**：
   - 通过 Cursor 的 Lint 检查发现漏洞
   - 溯源到上游 N.E.K.O 项目
   - 执行双向修复（上游 + 下游防护）

### 为什么会传播到下游

N.E.K.O.-RN 使用 `scripts/sync-neko-packages.js` 同步上游代码：

```javascript
// 默认行为：clean: true（镜像模式）
if (args.clean) {
  rmDirSync(destDir, args.dryRun);  // 完全删除目标目录
}
copyDirSync(srcDir, destDir, args.dryRun, args.verbose);  // 复制上游
```

**关键点**：
- `project-neko-common` 和 `project-neko-components` 都设置为 `clean: true`
- 每次同步会**完全覆盖**下游的 package.json
- 如果上游有问题，下游会被动继承

---

## 影响分析

### 受影响的文件

#### 上游（N.E.K.O）
1. ✅ `frontend/package.json`（根级）
2. ✅ `frontend/packages/common/package.json`
3. ✅ `frontend/packages/components/package.json`
4. ✅ `frontend/packages/audio-service/package.json`
5. ✅ `frontend/packages/live2d-service/package.json`
6. ✅ `frontend/packages/realtime/package.json`

所有文件从 `"vite": "^7.1.7"` 升级到 `"vite": "^7.1.11"`

#### N.E.K.O.-RN 项目（下游）
7. ⚠️ `packages/project-neko-common/package.json`（通过 override）
8. ⚠️ `packages/project-neko-components/package.json`（通过 override）
9. ⚠️ `packages/project-neko-audio-service/package.json`（通过 override）
10. ⚠️ `packages/project-neko-live2d-service/package.json`（通过 override）
11. ⚠️ `packages/project-neko-realtime/package.json`（通过 override）

所有下游包通过 `packages-overrides/*/package.json` 防护

### 暂未修复的文件

✅ **已完成全部修复** - 所有使用 vite 的 packages 均已升级到安全版本

---

## 解决方案实施

### 步骤 1：修复上游（N.E.K.O）

#### 1.1 更新根级 vite
```bash
# 文件：N.E.K.O/frontend/package.json
"devDependencies": {
  "vite": "^7.1.11"  # 从 ^7.1.7 升级
}
```

#### 1.2 更新 packages 中的 vite
```bash
# 文件：N.E.K.O/frontend/packages/common/package.json
# 文件：N.E.K.O/frontend/packages/components/package.json
"devDependencies": {
  "vite": "^7.1.11"  # 从 ^7.1.7 升级
}
```

#### 1.3 安装更新
```bash
cd /Users/noahwang/projects/N.E.K.O/frontend
npm install
```

### 步骤 2：防护下游（N.E.K.O.-RN）

#### 2.1 创建 override 文件
```bash
# 为所有 5 个使用 vite 的包创建 override
# 文件：N.E.K.O.-RN/packages-overrides/project-neko-common/package.json
# 文件：N.E.K.O.-RN/packages-overrides/project-neko-components/package.json
# 文件：N.E.K.O.-RN/packages-overrides/project-neko-audio-service/package.json
# 文件：N.E.K.O.-RN/packages-overrides/project-neko-live2d-service/package.json
# 文件：N.E.K.O.-RN/packages-overrides/project-neko-realtime/package.json

# 所有文件内容相同：
{
  "devDependencies": {
    "vite": "^7.1.11"
  }
}
```

#### 2.2 Override 的作用
- 同步脚本会先完全覆盖 packages（clean: true）
- 然后应用 `packages-overrides/` 中的文件
- 确保即使上游版本回退，下游也保持安全版本

#### 2.3 更新 README
在 `packages-overrides/README.md` 中记录这些 override 的原因。

### 步骤 3：验证修复

#### 3.1 验证上游
```bash
cd /Users/noahwang/projects/N.E.K.O/frontend

# 检查版本
grep -r "vite.*7.1" package.json packages/*/package.json

# 应该显示 ^7.1.11 而非 ^7.1.7

# 测试构建
npm run build:common
npm run build:components
```

#### 3.2 验证下游（运行同步）
```bash
cd /Users/noahwang/projects/N.E.K.O.-RN

# 运行同步脚本
node scripts/sync-neko-packages.js --packages common,components --verbose

# 验证 override 已应用
cat packages/project-neko-common/package.json | grep vite
cat packages/project-neko-components/package.json | grep vite

# 应该显示 ^7.1.11
```

---

## 技术机制说明

### Override 的工作原理

参考 `sync-neko-packages.js` 的实现：

```javascript
// 1. 清空目标目录（镜像模式）
rmDirSync(destDir, args.dryRun);

// 2. 复制上游完整内容
copyDirSync(srcDir, destDir, args.dryRun, args.verbose);

// 3. 应用 overlay（覆盖同名文件）
if (args.applyOverlay) {
  const overlayDir = path.join(rnRoot, "packages-overrides", mapping[key].dest);
  applyOverlayForPackage(overlayDir, destDir, args.dryRun, args.verbose);
}
```

**关键点**：
- Override 文件只需包含**要覆盖的字段**
- 不是完整的 package.json，只包含 `devDependencies`
- 同步脚本会用 override 中的内容**覆盖**同步过来的对应文件

**限制**：
- 如果上游 package.json 的其他部分变更，override 不会影响
- 只能覆盖**整个文件**，不能做字段级别的 merge（当前实现）
- 需要在 override 中保持完整的 JSON 结构（即使只覆盖部分字段）

### 为什么选择 Override 而非直接修改

| 方案 | 优点 | 缺点 |
|------|------|------|
| **直接修改下游** | 简单直接 | 下次同步会被覆盖，修复丢失 |
| **仅修改上游** | 治本，长期有效 | 如果上游回退，下游被动受影响 |
| **使用 Override**（✅ 采用） | 防护完善，即使上游回退也安全 | 需要维护额外文件 |
| **关闭 clean 模式** | 保留本地修改 | 失去镜像同步的好处，可能积累差异 |

---

## 长期改进建议

### 1. 自动化依赖检查

在 CI/CD 中添加漏洞扫描：

```yaml
# .github/workflows/security.yml
- name: Audit dependencies
  run: npm audit --audit-level=moderate
```

### 2. 同步前的上游校验

在 `sync-neko-packages.js` 中添加：

```javascript
function validateUpstreamPackageJson(pkgJsonPath) {
  const pkg = JSON.parse(fs.readFileSync(pkgJsonPath, 'utf8'));
  
  // 检查 vite 版本
  if (pkg.devDependencies?.vite) {
    const version = pkg.devDependencies.vite;
    if (version.includes('7.1.') && !version.includes('7.1.11')) {
      console.warn(`⚠️  Warning: ${pkgJsonPath} uses vulnerable vite ${version}`);
      return false;
    }
  }
  
  return true;
}
```

### 3. Override 的版本管理

考虑在 override 文件中添加元数据：

```json
{
  "_meta": {
    "reason": "Security fix for CVE-2025-62522",
    "addedDate": "2026-01-10",
    "upstreamFixed": false,
    "reviewDate": "2026-02-10"
  },
  "devDependencies": {
    "vite": "^7.1.11"
  }
}
```

### 4. 同步脚本增强

支持 package.json 的**字段级别 merge**（而非文件级覆盖）：

```javascript
// 伪代码
function mergePackageJson(base, overlay) {
  return {
    ...base,
    devDependencies: {
      ...base.devDependencies,
      ...overlay.devDependencies  // 只覆盖指定的依赖
    }
  };
}
```

---

## 验证清单

### 上游（N.E.K.O）
- [x] 根 package.json 的 vite 已升级到 ^7.1.11
- [x] packages/common/package.json 的 vite 已升级到 ^7.1.11
- [x] packages/components/package.json 的 vite 已升级到 ^7.1.11
- [x] packages/audio-service/package.json 的 vite 已升级到 ^7.1.11
- [x] packages/live2d-service/package.json 的 vite 已升级到 ^7.1.11
- [x] packages/realtime/package.json 的 vite 已升级到 ^7.1.11
- [ ] 运行 `cd frontend && npm install` 更新 lockfile
- [ ] 测试构建是否正常：`npm run build`

### 下游（N.E.K.O.-RN）
- [x] 创建 `packages-overrides/project-neko-common/package.json`
- [x] 创建 `packages-overrides/project-neko-components/package.json`
- [x] 创建 `packages-overrides/project-neko-audio-service/package.json`
- [x] 创建 `packages-overrides/project-neko-live2d-service/package.json`
- [x] 创建 `packages-overrides/project-neko-realtime/package.json`
- [x] 更新 `packages-overrides/README.md` 记录 override 原因
- [ ] 运行同步脚本：`node scripts/sync-neko-packages.js`
- [ ] 验证 override 已生效：`grep vite packages/project-neko-*/package.json`
- [ ] 测试 Metro 是否能正常解析包

### 文档
- [x] 创建本溯源文档
- [ ] 更新 `docs/frontend/packages/README.md` 添加安全修复说明
- [ ] 在 `.cursorrules` 中添加依赖版本审查规则

---

## 相关文档

- [Metro 和 Vite 依赖修复](./bugfix-metro-vite-dependency-2026-01-10.md) - 初次添加 vite 依赖的背景
- [Packages 同步流程](../../N.E.K.O.-RN/docs/upstream-frontend-packages.md)
- [Packages Overrides 机制](../../N.E.K.O.-RN/packages-overrides/README.md)

---

## 总结

**问题性质**：
- 安全漏洞（CVE-2025-62522）
- 依赖管理问题（上游不安全版本传播到下游）

**修复策略**：
- 上游修复：升级到安全版本 `^7.1.11`
- 下游防护：使用 override 机制确保安全

**关键经验**：
1. 跨项目同步需要考虑安全性
2. Override 机制不仅用于平台差异，也可用于安全防护
3. 依赖版本应该显式声明，而非依赖 hoisting
4. 需要建立自动化的安全检查流程

**后续行动**：
- 完成所有验证清单项
- 排查其他可能受影响的 packages
- 建立 CI 中的漏洞扫描
- 定期审查 override 文件的必要性

---

**修复完成时间**：2026-01-10  
**修复人员**：通过 Cursor AI 协助完成  
**审查状态**：待验证
